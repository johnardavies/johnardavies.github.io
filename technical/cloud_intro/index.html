---
author: "John Davies"
title: "Introduction to launching a Virtual Machine in the Cloud"
date: "2021-31-12" 
tags: [ "technical", "digital" ]
categories: [ "technical" ]
cover:
    image: "/Cloud_image.jpg"
---
*Photograph of Es Devlin's "BLUEWHITESKY" at the 2021 LUX exhibition* 

More and more of the digital services we use involve the cloud, where the computing is not done on our laptop or mobile, but accessed over the internet. However, coming across its technical details for the first time, the cloud can seem slightly mysterious to someone whose original background is not computing - I certainly found it that way. From a data science perspective working with it involves things that are not related to statistics, machine learning or even programming narrowly defined.

Virtual machines are one of the fundamental building blocks of cloud services and an obvious starting point to the topic. 
In this post I cover:

**1. Setting up a virtual machine in the cloud**  
**2. Increasing the security of the machine**\
**3. Stopping the machine and turning it off** 

A cloud based virtual machine can allow access to much greater computing power than is available on a laptop, allowing data processing and model training to be sped up. Alternatively we can also use a less powerful virtual machine 
to remotely host API calls, webscraping or sites without having to worry about keeping our laptop open to run them.

It's probably true that tools like google colab or serverless are reducing the need for data scientists to directly use virtual machines. However as the cloud increases in importance, knowing more about its core components is useful in general. It also makes it easier to work with different cloud providers as virtual machines are a standard offer.

**Prerequisites**
The prerequisites are some knowledge of the basics of the command line and networking. If these are less familiar a good way to learn them, or at least I found it helpful, is to buy a raspberry pi and learn how to login remotely to it over your local network (so called "headless login") as this is similar to many of the steps here - the raspberry pi is effectively acting as a remote machine analagous to the virtual machine in the cloud. A benefit of this approach is that the cost of doing this is fixed and there are fewer security issues as the pi won't be on the public internet.

The instructions should work from a Mac or PC (using windows subsystem for linux) as the local machine. The cloud machine will be linux as this is the most common operating system in the cloud - even on the Microsoft's Azure cloud platform.

**The warning no cloud tutorial is without** The cloud can be many things, but one thing it is not is free. Although many cloud platforms have free credits for new users, it is important to look at the cost of services before using them, to regularly monitor usage and costs and to turn things off - otherwise things can get expensive.

## 1.  Setting up a Virtual Machine in the cloud

In this example we use a virtual machine (VM) from the cloud provider [Digital Ocean](<https://cloud.digitalocean.com/>). Digital Ocean call their virtual machines Droplets, but in practice there is a lot of similarity between cloud providers' virtual machines. In large part this is because they are mostly linux based, although size and capacity (and hence cost) can vary a lot. Using a virtual machine from another provider such as Amazon Web Service's (AWS) EC2 instance is quite similar, although in the case of AWS there are some different actions in the set-up and the billing is not capped. 

After having created an account, navigate to the *Create* button in Digital Ocean and select *Droplets* from the dropdown.
 ![Starting digital ocean](/droplet_setup.png)
We select an Ubuntu instance version of linux on the smallest plan cost which is $5 a month. We choose a local datacenter and a form of authentification. From the authentification options we use Secure Shell (SSH) key based authentification, rather than password based login as this is more secure as it also requires an ssh key to login. If you don't have an existing key to set up go to the **New SSH Key** button and follow the steps. To generate a key run `$ ssh-keygen` from the command line which will then prompt you to give the key a password and save the keys. This will generate two keys: The private one (id_rsa) and the public one (id_rsa.pub) - these are the default names for a new key which will be saved to the ssh folder. Use `$ cat ~/.ssh/id_rsa.pub` to see the public key and copy and paste this into the indicated field.

Select the number of droplets you want to launch. In this case 1 and give the droplet a hostname such as **test-virtual-machine**. Finally when all the fields are finished hit the **Create Droplet** button at the bottom and the droplet will launch.

The droplet will then launch and its details will be visible (including what its ip address is) under the **Droplets** tab under **Manage**. 
 ![Droplet screen](/droplet_screen.jpg)

If you replace the ip_address below with the Droplet's IP address and you should be able to log in from your local machine's command line using:
`$ ssh root@ip_address`\
 if you have multiple ssh keys add the -i flag to add the file path to the specific private key you are using:
`$ ssh -i /path/to/private_key username@ip_address`

In the example above the IP address is 134.122.96.10, so the login would be\
`$ ssh root@134.122.96.10`
\
The first time you do this you will asked:\
`Are you sure you want to continue connecting (yes/no)?`
Type yes and hit enter and you should see something like the screen below.
 ![Welcome screen](/welcome_screen.jpg)
\
You now have a machine that, until you turn it off, can run programmes that you want remotely or act as web server 24/7. However, as stands it could be more secure so we take some steps to increase this.

## 2. Increasing the security of the machine 
Unfortunately this stage is necessary as with the virtual machine on the public internet it will quickly be subject to repeated login attempts from bots around the world who are trying to break in.

If you want to see these `$ lastb  | more` from the command line of the virtual machine will show you a list of failed login attempts on your virtual machine (The more command makes the list scrollable which becomes necessary given the number of login attempts).\
*A small sample of unwanted visitors* 
 ![Unwanted visitors](/unwanted_visitors.jpg)

To help make the virtual machine more secure we therefore:

1. Activate a Firewall for the virtual machine which restricts how it can be accessed
2. Create an account which has restricted privileges and only allows access to the machine via that account

In AWS a lot of this is handled through what are known as Identity and Access Managment (IAM) roles. Here we use a standard linux firewall and restrictions on who has access privileges so this is less dependent on the specifics of Digital Ocean. The commands here should be executed on the virtual machine.

**2.1 Activate a Firewall**\
To reduce the scope for this we lock down access to all but one of the ports using a firewall leaving the only means of access the login ssh.

**1.** Installing Uncomplicated Fire Wall (UFW). It should already be installed, but if not, the following command will install the latest version. The cursor now appears as # as we are logged in as root (The account with the highest level of privilege).\
`# apt install ufw`<br />

**2.** Enable ufw to run. The default is to deny all incoming connections and allow all outgoing connections.\
`# ufw enable`<br />

**3.** Check to see if ufw is running.\
`# ufw status`<br />

**4.** Allow ssh connections. This will allow us to only connect with ssh on port 22, which is the standard port for SSH.\
`# ufw allow ssh`<br />

**5.** Restrict the rate at which SSH connections can be formed - this blocks connections from IPs that have attempted 6 or more connections in past 30 seconds.\
`# ufw limit ssh`<br />

**2.2 Create a new user account and prevent access with unrestricted privileges**\ 

We create a user account which we will use to log into the virtual machine going ahead and then remove the direct root access. The reason for doing this is that the default way of logging in with root access gives the user unlimited privileges on the virtual machine, so if someone broke in with the root access default they can do what they want - including locking us out of the system. Allowing access to the root privileges from a new account
only with a password restricts this from happening as someone who got access to the machine would also need to force the root password to get this level of control.

**1.** To create a new user account, here called new_user. It will ask you for a password for root access and to input some information on the user.\
`# adduser new_user`<br />

**2.** Give the user 'new_user' the admin privileges.\
`# usermod -aG sudo new_user`<br />

**3.** Check you can get the admin privileges. It will prompt you for the new_user password.\
`# su - new_user` after this it will switch to `new_user@test-virtual-machine`.<br />

**4.** Assuming we want to use the same key for the new user copy the key details over to the new user.
`# rsync --archive --chown=new_user:new_user ~/.ssh /home/new_user`\ 
*When doing this check ~/.ssh is not written as ~/.ssh/ as if this happens it will copy the whole ssh directory and not just the key*<br />

**5.** Now log out by typing `exit` and check you can ssh into the virtual machine from your computer as the new user. It will ask for the key password.\
`$ ssh -i /path/to/private_key new_user@ip_address`<br />

**6.** Assuming you can login as the new user, edit the sshd_config to forbid root logins. If logging in as the new user is not possible then there is a risk of being locked out when you make this change. \
`$ sudo nano /etc/ssh/sshd_config`<br />

and change the PermitRootLogin line so it reads `PermitRootLogin no`.

**7.** Restart the service so that the changes take effect.\
`$ sudo service sshd restart`<br />

From now on log in as the new user<br />
`$ ssh -i /path/to/private_key new_user@ip_address`<br />

There are further security restrictions one can implement such as **Fail2Ban** which will block ip addresses if they make incorrect login attempts more than a set number of times.

 If the virtual machine is on for an extended length of time it is also important to make sure it is kept up to date, using `$ sudo apt-get update && apt-get upgrade`. The update command updates the list of available packages and upgrade installs the latest version of the packages that the machine has.`

**3. Stopping the machine and turning it off**

To log out of the virtual machine and leave it running.
`$ exit` will log you out.

The following command run from the virtual machine will stop it running and turn its power off. This will disrupt running processes, but retain files that were already saved on the droplets allowing it to be restarted.\
`$ sudo shutdown -h now`

You can also turn off droplets from the web interface which will maintain their state if you relaunch them (although you will still be billed for them while stopped).
To destroy the droplet there is a button on the web interface which will remove them and their contents completely ending the billing.
The terminology is similar with AWS where EC2 virtual machine instances are 'stopped' and 'destroyed'

**Sources:**

Digital Ocean, Guidance on ssh connections
https://docs.digitalocean.com/products/droplets/how-to/connect-with-ssh/openssh/

Digital Ocean, Guidance on ufw
https://www.cyberciti.biz/faq/howto-limiting-ssh-connections-with-ufw-on-ubuntu-debian/

Gite, V. Open SSH server best practices
https://www.cyberciti.biz/tips/linux-unix-bsd-openssh-server-best-practices.html#comments

For AWS

For a guide on setting up a virtual machine for machine learning on Amazon:
Stathoulopoulos, K., How to set up a GPU instance for machine learning on AWS
https://kstathou.medium.com/how-to-set-up-a-gpu-instance-for-machine-learning-on-aws-b4fb8ba51a7c

For AWS in general
Wittig, M. and Andreas, W., 'Amazon Web Services in action', Manning.


